<html><head><base href="/">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shop Configuration - CryptoFans</title>
	<meta name="description" content="CryptoFans - Create and Share Content with any Token on Polygon network">
	<meta name="img" content="https://cryptofans.io/img/preview.png">
  <meta property="og:image" content="https://cryptofans.io/img/preview.png">
  <meta name="twitter:image" content="https://cryptofans.io/img/preview.png">
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600&amp;display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.5.2/web3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js"></script>
  <script id="exdc" src="https://exdc.cc/sdk.js" type="module"></script>
  <link rel="stylesheet" href="/styles/styles.css">
  <link rel="stylesheet" href="/styles/myshop.css">
  <script src="/anim.js"></script>
</head>
<body>
  <embed type="text/html" src="/components/nav.html" class="embed-nav">
  <div class="container">

    <div class="overlay" id="pay-modal">
      <div class="popup">
        <h2>Buy Subscription</h2>
        <p>5 USDC / 28 days + 5 EXDC to create a new contract</p>
        <br>
        <button class="btn" id="buyButton">Buy</button>
      </div>
    </div>

    <h1>Shop Configuration</h1>
    
    <form class="shop-config" id="shop-config-form">
      <div class="form-group">
        <label for="shop-name">Shop Name</label>
        <input type="text" id="shop-name" name="shop-name" required>
      </div>
      
      <div class="form-group">
        <label for="file-upload" class="file-input-label">Shop Avatar</label>
        <input type="file" id="file-upload" name="file-upload" required accept="image/png, image/jpeg">
      </div>

      <div class="form-group">
        <label for="shop-description">Shop Description</label>
        <textarea id="shop-description" name="shop-description" rows="4" required></textarea>
      </div>

      <div class="form-group">
        <label for="default-currency">Currency</label>
        <select id="default-currency" name="default-currency" required>
          <option value="USDC">USDC</option>
        </select>
      </div>

      <div class="subscription-tiers">
        <div class="tiers-list">
          <h2>Subscription Tiers</h2>
          <div id="tiers-list-container"></div>
          <button type="button" class="btn add-tier-btn hidden" id="add-tier-btn">Add Tier</button>
        </div>
        <div class="tier-details">
          <h2>Tier Details</h2>
          <div id="tier-details-container"></div>
        </div>
      </div>

      <div class="form-group hidden">
        <label for="commission-rate">Commission Rate (%)</label>
        <input type="number" id="commission-rate" name="commission-rate" min="0" max="100" step="0.1" required>
      </div>

      <div class="action-buttons">
        <button type="submit" class="btn" id="save-btn">Save Configuration</button>
        <button type="button" class="btn btn-secondary" id="cancel-btn">Cancel</button>
      </div>
    </form>
  </div>

  <div id="animation-container"></div>
  <embed type="text/html" src="/components/footer.html" class="embed-footer">

  <script>
    const validateSubscription = async () => {
      try {
        const subscription = await exdc.getCryptoFansAddress()
        const info = await exdc.getServicePaymentInfo(subscription)
        console.info('subscription', subscription, info)
        // console.info('subscription', subscription)
        const isServiceValid = await exdc.checkServiceValid(subscription)
        console.info('isvalid', isServiceValid)
        if(isServiceValid === true) {
          document.getElementById("pay-modal").className = "hidden";
        }
      } catch(err) {
        console.error('err', err)
      }
    }
    const buyButton = document.getElementById("buyButton")
    buyButton.addEventListener("click", async ()=>{
      const subscription = await exdc.getCryptoFansAddress()
      const smart = await exdc.buyServiceSmart(subscription)
      const isServiceValid = await exdc.checkServiceValid()
      if(isServiceValid === true) {
        document.getElementById("pay-modal").className = "hidden";
      }
    })
    
    var script = document.querySelector('#exdc');
    script.addEventListener('load', function() {
      window.exdc = new EXDC_SDK()
      exdc.checkMetaMask().then(()=>{
        validateSubscription()
      })
    })
  

    // Subscription tier management
    let tiers = [];
    let selectedTierId = null;

    function addTier(name = '', price = '', duration = '', benefits = '') {
      const tierId = `tier-${tiers.length}`;
      const newTier = { id: tierId, name, price, duration, benefits };
      tiers.push(newTier);
      renderTiersList();
      renderTierDetails(tierId);
    }

    function updateTier(tierId, name, price, duration, benefits) {
      const index = tiers.findIndex(tier => tier.id === tierId);
      if (index !== -1) {
        tiers[index] = { ...tiers[index], name, price, duration, benefits };
        renderTiersList();
        renderTierDetails(tierId);
      }
    }

    function removeTier(tierId) {
      tiers = tiers.filter(tier => tier.id !== tierId);
      renderTiersList();
      if (selectedTierId === tierId) {
        selectedTierId = null;
        renderTierDetails(null);
      }
    }

    function renderTiersList() {
      const container = document.getElementById('tiers-list-container');
      container.innerHTML = tiers.map(tier => `
        <div class="tier-item ${tier.id === selectedTierId ? 'active' : ''}" onclick="selectTier('${tier.id}')">
          ${tier.name}
        </div>
      `).join('');
    }

    function renderTierDetails(tierId) {
      const container = document.getElementById('tier-details-container');
      if (!tierId) {
        container.innerHTML = '<p>Select a tier to view details</p>';
        return;
      }

      const tier = tiers.find(t => t.id === tierId);
      if (!tier) return;

      container.innerHTML = `
        <div class="form-group">
          <label for="${tier.id}-name">Tier Name</label>
          <input type="text" id="${tier.id}-name" value="${tier.name}" onchange="updateTierField('${tier.id}', 'name', this.value)">
        </div>
        <div class="form-group">
          <label for="${tier.id}-price">Price</label>
          <input type="number" id="${tier.id}-price" value="${tier.price}" onchange="updateTierField('${tier.id}', 'price', this.value)">
        </div>
        <div class="form-group">
          <label for="${tier.id}-duration">Duration (days)</label>
          <input type="number" id="${tier.id}-duration" value="${tier.duration}" onchange="updateTierField('${tier.id}', 'duration', this.value)">
        </div>
        <div class="form-group">
          <label for="${tier.id}-benefits">Benefits</label>
          <textarea id="${tier.id}-benefits" rows="3" onchange="updateTierField('${tier.id}', 'benefits', this.value)">${tier.benefits}</textarea>
        </div>
        <button type="button" class="btn btn-secondary hidden" onclick="removeTier('${tier.id}')">Remove Tier</button>
      `;
    }

    function selectTier(tierId) {
      selectedTierId = tierId;
      renderTiersList();
      renderTierDetails(tierId);
    }

    function updateTierField(tierId, field, value) {
      const tier = tiers.find(t => t.id === tierId);
      if (tier) {
        tier[field] = value;
        renderTiersList();
      }
    }

    document.getElementById('add-tier-btn').addEventListener('click', () => addTier('New Tier', '0', '30', ''));

    // Form submission
    document.getElementById('shop-config-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Get form data
      const shopName = document.getElementById('shop-name').value;
      const shopDescription = document.getElementById('shop-description').value;
      const defaultCurrency = document.getElementById('default-currency').value;
      const commissionRate = document.getElementById('commission-rate').value;

      // Prepare shop configuration object
      const shopConfig = {
        name: shopName,
        description: shopDescription,
        defaultCurrency,
        commissionRate,
        subscriptionTiers: tiers
      };

      // Here you would typically send this data to your backend or smart contract
      console.log('Shop configuration to be saved:', shopConfig);

      // Simulating a successful save
      // alert('Shop configuration saved successfully!');
      
      // Optionally, redirect to the shop page or refresh the current page
      // window.location.href = '/shop';
    });

    // Cancel button
    document.getElementById('cancel-btn').addEventListener('click', () => {
      if (confirm('Are you sure you want to cancel? All changes will be lost.')) {
        window.location.href = '/profile';
      }
    });

    // Load existing shop configuration
    function loadExistingConfig() {
      // This function would typically fetch the shop configuration from your backend or smart contract
      // For this example, we'll use mock data
      const mockConfig = {
        name: "",
        description: "",
        defaultCurrency: "USDC",
        subscriptionTiers: [
          {name: "Paid", price: 10, duration: 28, benefits: "Access to basic content"}
        ]
      };

      // Populate form fields
      document.getElementById('shop-name').value = mockConfig.name;
      document.getElementById('shop-description').value = mockConfig.description;
      document.getElementById('default-currency').value = mockConfig.defaultCurrency;

      // Add subscription tiers
      mockConfig.subscriptionTiers.forEach(tier => {
        addTier(tier.name, tier.price, tier.duration, tier.benefits);
      });

      // Select the first tier by default
      if (tiers.length > 0) {
        selectTier(tiers[0].id);
      }
    }

    // Load existing configuration when the page loads
    loadExistingConfig();
  </script>
</body></html>